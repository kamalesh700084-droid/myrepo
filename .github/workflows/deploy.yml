name: Deploy Application

on:
  workflow_dispatch: # Manual trigger as per requirements

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create Dummy Artifact
        run: |
          echo "Building application..." > build-output.txt
          echo "v1.0.${{ github.run_number }}" >> build-output.txt

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-build
          path: build-output.txt

  deploy:
    needs: build
    runs-on: [self-hosted, aws-deployment] # Using your specific AWS runner label
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: app-build
          path: ./deployment

      - name: Prepare Deployment Script
        run: |
          chmod +x deploy.sh
          # If deploy.sh doesn't exist in your repo, this creates a basic one
          if [ ! -f deploy.sh ]; then
            echo "#!/bin/bash" > deploy.sh
            echo "echo 'Starting deployment on AWS...'" >> deploy.sh
            echo "cat ./deployment/build-output.txt" >> deploy.sh
            echo "echo 'Deployment Complete!'" >> deploy.sh
            chmod +x deploy.sh
          fi

      - name: Execute Deployment
        run: ./deploy.sh
